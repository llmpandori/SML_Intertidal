################################################
# title: 2019-2021 EDI Update - SML Transect Data
# author: Lauren Pandori
# started: 7/24/22
# last edited: 7/24/22
###############################################

##### Introduction #####

# This script was written in the summer of 2022 by Lauren Pandori, SML Rocky Intertidal Intern Mentor. This script is based on a script developed by An T Nguyen (EDI Environmental Data Fellow at Shoals Marine Lab in 2018). An's script is available in this repo - 'Cleaning_script.Rmd'. Please email llmpandori@gmail.com with any questions/issues. 

# Shoals Marine Lab Rocky Intertidal Monitoring Data collected between 2019 and 2021 are added to the EDI repository files generated by An T Nguyen in 2018. 

# Some files were not updated since no new information is contributed: 
# transect_info.csv
# 

##### Terms and General Notes ##### 

# Data Structure : The first 5 columns of each sheet are the "core" columns that describe Year, Transect, Level, Replicate and Data_taken (whether or not data were collected). They represent the information that uniquely identifies one row of data, and are kept intact. 


##### packages #####

library(readxl)
library(janitor)
library(reshape2)
library(data.table)
library(tidyverse)

##### presets (file locations, save locations, figure theme) #####

edi_file <- './data/edi_update_data_2021/edi/'
to_add <- './data/edi_update_data_2021/to_add/'

##### category #####

# read in edi file
cat_edi <- read_csv(paste0(edi_file, 'categories_data.csv'),
                         col_types = cols(Replicate = col_character()))

# generate list of dataframes to add to edi data
cat_add <- map(
                # generate list of files to add
                list.files(path = to_add, pattern = 'Transect', 
                           # full file path + all files
                           all.files= T, full.names = T),
                # read 4th sheet of excel file (category data)
                read_xlsx, sheet = 4)

# tidy category data
cat_add <- cat_add %>%
  # make each organism a column and fill the columns with category values
  map(pivot_longer, cols = -c(1:5), names_to = 'Organism', 
      values_to = 'Category') %>%
  # change the category column to charachter formatting
  map(mutate, Category = as.character(Category)) %>%
  # join list of data frames by common columns
  reduce(full_join, by = c("YEAR", "TRANSECT", "LEVEL", 
                           "REPLICATE", "DATA TAKEN?", 
                           "Organism", "Category"))

# more data tidying after making a df
cat_add <- cat_add %>%
  # remove places where the entire row or column consists of 'NA'
  # remove_empty(which = c('rows', 'cols')) %>%
  # make column names consistent with cat_edi data
  rename(Year = YEAR, Transect = TRANSECT, Level = LEVEL, 
         Replicate = REPLICATE, Data_taken = `DATA TAKEN?`) %>%
  # make data taken column consistent
  # if the first letter is 'y', then 'yes'
  # if first letter is 'n', then 'no'
  mutate(Data_taken = case_when(
    tolower(substr(Data_taken,1,1)) == 'y' ~ 'yes',
    tolower(substr(Data_taken,1,1)) == 'n' ~ 'no')) %>%
  # reduce duplicate species columns
  mutate(Organism = case_when(
    # un-abbreviate semibalanus and botryllus
    substr(Organism, 1,9) == 'Botryllus' ~ 'Botryllus schlosseri',
    Organism == 'Sb. balanoides' ~ 'Semibalanus balanoides',
    # fix inconsistent capitalization
    tolower(Organism) == 'fucus base' ~ 'Fucus base',
    tolower(Organism) == 'bare rock' ~ 'bare rock',
    # if not included in above, keep original entry
    T ~ Organism
    ))

# What to do with genus w/o species? e.g. Electra vs Electra pilosa 

# remove emtpy rows or errant rows
cat_add2 <- cat_add %>%
  # remove rows where NA values shouldn't have data
  filter(!is.na(Year) & !is.na(Transect) & !is.na(Level))
  
  
View(filter(cat_add, is.na(Year) | is.na(Transect) | is.na(Level)))

##### 